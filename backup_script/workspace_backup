SHELL := bash

rsync_to_nas := rsync --verbose --archive --human-readable --partial --progress \
				--compress --compress-choice=lz4 \
				--delete-delay \
				--exclude '.DS_Store' --exclude '.localized'

restic_set_password := RESTIC_PASSWORD=TODO
restic_set_repo := RESTIC_REPOSITORY=sftp:nas:/path/to/repo
restic_set_env := ${set_password} ${set_repo}

forget_rule := --keep-within-hourly 1d --keep-within-daily 1m --keep-within-weekly 10y
exclude := --exclude='.DS_Store' --exclude='**/node_modules/**' --exclude='**/_build/**'

.PHONY: snapshots
snapshots:
	${restic_set_env} restic snapshots -g paths

.PHONY: backup
backup:
	${rsync_to_nas} ~/Desktop/ nas:/path/to/desktop/
	${rsync_to_nas} ~/Documents/ nas:/path/to/documents/
	${restic_set_env} restic backup ${exclude} ~/Desktop
	${restic_set_env} restic backup ${exclude} ~/Documents
	${restic_set_env} restic backup ${exclude} ~/workspace

.PHONY: forget
forget:
	@if [[ $(shell date '+%u') == 7 ]]; then \
		${restic_set_env} restic forget --verbose --group-by paths ${forget_rule} --dry-run; \
		echo "${restic_set_env} restic forget --verbose --group-by paths ${forget_rule} --dry-run"; \
		else \
		echo "'forget' is only allowed to run on Sunday"; \
		fi

.PHONY: prune
prune:
	${restic_set_env} restic prune --dry-run
	@echo "${restic_set_env} restic prune --dry-run"

.PHONY: stats
stats:
	${restic_set_env} restic stats

.PHONY: ls
ls:
	${restic_set_env} restic ls latest
