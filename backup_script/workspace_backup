SHELL := bash

rsync_to_nas := rsync --verbose --archive --compress --human-readable --partial --progress \
				--delete-after \
				--exclude '.DS_Store' --exclude '.localized'

set_password := RESTIC_PASSWORD=TODO
set_repo := RESTIC_REPOSITORY=sftp:nas:/path/to/repo
set_env := ${set_password} ${set_repo}

forget_rule := --keep-within-hourly 1d --keep-within-daily 1m --keep-within-weekly 10y
exclude := --exclude='.DS_Store' --exclude='**/node_modules/**'

.PHONY: stats
stats:
	${set_env} restic stats

.PHONY: snapshots
snapshots:
	${set_env} restic snapshots -g paths

.PHONY: backup
backup:
	${rsync_to_nas} ~/Desktop/ nas:/path/to/desktop/
	${rsync_to_nas} ~/Documents/ nas:/path/to/documents/
	${set_env} restic backup ${exclude} ~/Desktop
	${set_env} restic backup ${exclude} ~/Documents
	${set_env} restic backup ${exclude} ~/workspace

.PHONY: forget
forget:
	@if [[ $(shell date '+%u') == 7 ]]; then \
		${set_env} restic forget ${forget_rule} --dry-run; \
		echo "${set_env} restic forget -v ${forget_rule} --dry-run"; \
		else \
		echo "'forget' is only allowed to run on Sunday"; \
		fi

.PHONY: prune
prune:
	${set_env} restic prune --dry-run
	@echo "${set_env} restic prune --dry-run"

.PHONY: ls
ls:
	${set_env} restic ls latest
